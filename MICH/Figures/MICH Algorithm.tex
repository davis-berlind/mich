\begin{algorithm}
\label{alg:mich}
\caption{Variational Bayes Approximation to MICH Posterior.}

\footnotesize
\SetAlgoLined
  Inputs: $\mathbf{y}_{1:T},\:\mu_0,\:\lambda_0,\:L,\:K,\:J,\:\{\omega_\ell,\boldsymbol{\pi}_\ell\}_{\ell=1}^L,\:\{u_k,v_k,\boldsymbol{\pi}_k\}_{k=1}^K,\:\{\omega_j,u_j,v_j,\boldsymbol{\pi}_j\}_{j=1}^J;$ \\
  Initialize: $\overline{\boldsymbol{\Theta}} := \{\{\overline{\boldsymbol{\theta}}_\ell\}_{\ell=1}^L$, $\{\overline{\boldsymbol{\theta}}_k\}_{k=1}^K$, $\{\overline{\boldsymbol{\theta}}_j\}_{j=1}^J\}$;
  
  \Repeat {Convergence} {
    \For{$\ell=1$ \KwTo $L$} {
      $\tilde{r}_{-\ell t} := y_t -\mu_0- \sum_{\ell' \neq \ell}^L \E[\mu_{\ell' t}] - \sum_{j =1}^J \E[\lambda_{jt} \mu_{jt}] / \E[\lambda_{jt}]$ \tcp*{l\textsuperscript{th} partial mean residual}
      $\overline{\lambda}_{t} := \lambda_0\prod_{k=1}^K \E[\lambda_{kt}]\prod_{j=1}\E[\lambda_{jt}]$ \tcp*{precision of residual} 
      $\overline{\boldsymbol{\theta}}_\ell := \texttt{mean-scp}(\tilde{\mathbf{r}}_{-\ell} \:;\: \overline{\boldsymbol{\lambda}}_{1:T}, \omega_{\ell}, \boldsymbol{\boldsymbol{\pi}}_{\ell})$ \tcp*{update mean-scp parameters}
    }
    \For{$k=1$ \KwTo $K$} {
      $\tilde{r}_{t} := y_t  -\mu_0- \sum_{\ell = 1}^L \E[\mu_{\ell t}] - \sum_{j=1}^J \E[\lambda_{jt} \mu_{jt}] / \E[\lambda_{jt}]$ \tcp*{mean residual} 
      $\overline{\lambda}_{-kt} :=  \lambda_0\prod_{k' \neq k} \E[\lambda_{k't}]\prod_{j=1}^J\E[\lambda_{jt}] $ \tcp*{k\textsuperscript{th} partial scale residual} 
      %% $\delta_{t} := \sum_{\ell=1}^L  \Var(\mu_{\ell t} ) + \sum_{j=1}^J[\E[\lambda_{jt} \mu^2_{jt}] / \E[\lambda_{jt}] - (\E[\lambda_{jt} \mu_{jt}] / \E[\lambda_{jt}])^2 ];$ \tcp*{variance correction term}\\
      Compute $\boldsymbol{\delta}_{1:T}$, $\tilde{\mathbf{v}}_{k}$, and $\tilde{\boldsymbol{\boldsymbol{\pi}}}_{k}$ by (\ref{eq:delta}), (\ref{eq:v-k-corrected}), and (\ref{eq:pi-k-corrected}) \tcp*{variance corrected priors} 
      $\overline{\boldsymbol{\theta}}_k := \texttt{var-scp}(\tilde{\mathbf{r}}_{1:T} 
      \:;\:\overline{\boldsymbol{\lambda}}_{-k}, u_k, \tilde{\mathbf{v}}_{k}, \tilde{\boldsymbol{\boldsymbol{\pi}}}_k)$ \tcp*{update var-scp parameters}
    }
    \For{$j=1$ \KwTo $J$} {
      $\tilde{r}_{-jt} := y_t -\mu_0- \sum_{\ell = 1}^L \E[\mu_{\ell t}] - \sum_{j' \neq j} \E[\lambda_{j't} \mu_{j't}] / \E[\lambda_{j't}]$ \tcp*{j\textsuperscript{th} partial mean residual} 
      $\overline{\lambda}_{-jt} := \lambda_0\prod_{k=1}^K \E[\lambda_{kt}]\prod_{j' \neq j}\E[\lambda_{j't}] $ \tcp*{j\textsuperscript{th} partial scale residual}
      %%$\delta_{-jt} := \sum_{\ell=1}^L  \Var(\mu_{\ell t} ) + \sum_{j' \neq j}[\E[\lambda_{j't} \mu^2_{j't}] / \E[\lambda_{j't}] - (\E[\lambda_{j't} \mu_{j't}] / \E[\lambda_{j't}])^2 ]$ \tcp*{j\textsuperscript{th} variance correction term} 
      Compute $\boldsymbol{\delta}_{-j}$, $\tilde{\mathbf{v}}_{j}$, and $\tilde{\boldsymbol{\boldsymbol{\pi}}}_{j}$ by (\ref{eq:delta-j}), (\ref{eq:v-j-corrected}), and (\ref{eq:pi-j-corrected}) \tcp*{variance corrected priors} 
      $\overline{\boldsymbol{\theta}}_j := \texttt{meanvar-scp}(\tilde{\mathbf{r}}_{-j} \:;\:\overline{\boldsymbol{\lambda}}_{-j}, \omega_j, u_j, \tilde{\mathbf{v}}_{j}, \tilde{\boldsymbol{\boldsymbol{\pi}}}_j)$ \tcp*{update meanvar-scp parameters}
    }
  }
  \Return{Posterior Parameters: $\overline{\boldsymbol{\Theta}}$}.
\end{algorithm}