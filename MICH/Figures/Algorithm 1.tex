\begin{algorithm}[!h]
\label{alg:1}
\small
\SetAlgoLined
  Inputs: $J;\:K;\:L;\:B_l;\:B_r;\:\{\tau_j,u_j,v_j,\pi_j\}_{j=1}^J;\:\{\tau_\ell,\pi_\ell\}_{\ell=1}^L;\:\{u_k,v_k,\pi_k\}_{k=1}^K$; \\
  Initialize: $\tilde{\mathbf{r}} := \mathbf{y}$; $\overline{\pmb{\lambda}}:= \mathbf{1}$; $\pmb{\delta}:=\mathbf{0}$; $\{\{\overline{b}_{jt}, \overline{\tau}_{jt}, \overline{u}_{jt}, \overline{v}_{jt}, \overline{\pi}_{jt}\}_{t=1}^T\}_{j=1}^J$; $\{\{\overline{b}_{\ell t}, \overline{\tau}_{\ell t}, \{\overline{\pi}_{\ell t}\}_{t=1}^T\}_{\ell=1}^L$; $\{\{\overline{u}_{kt}, \overline{v}_{kt}, \overline{\pi}_{kt}\}_{t=1}^T\}_{k=1}^K$;\\
  
  \Repeat {Convergence} {
    $j:=1;\;\ell:=1;\;k:=1;$ \\
    \While{$j \leq J$} {
      $\tilde{r}_t := \tilde{r}_t + \E_q[\lambda_{jt}]^{-1}\E_q[\lambda_{jt} \mu_{jt}],\; \sforall t$; \texttt{// calculate partial residuals} \\
      $\overline{\lambda}_t := \E_q[\lambda_{jt}]^{-1}\overline{\lambda}_t, \; \sforall t$; \\
      $\delta_t := \delta_t - \E_q[\lambda_{jt}]^{-1}\E_q[\lambda_{jt} \mu^2_{jt}] + (\E_q[\lambda_{jt}]^{-1}\E_q[\lambda_{jt} \mu_{jt}])^2,\; \sforall t;$ \\
      Calculate: $\tilde{v}_{jt}$ and $\tilde{\pi}_{jt}$ by (\ref{eq:mod-v_j}) and (\ref{eq:mod-pi_j}), $\sforall t$; \texttt{// calculate corrected priors} \\
      $\{\overline{b}_{jt}, \overline{\tau}_{jt}, \overline{u}_{jt}, \overline{v}_{jt}, \overline{\pi}_{jt}\}_{t=1}^T := \texttt{SMSCP}(\tilde{\mathbf{r}} \:;\:\overline{\pmb{\lambda}}, \tau_j, u_j, \{\tilde{v}_{jt}\}_{t=1}^T, \tilde{\pmb{\pi}}_j, B_l,B_r);$ \texttt{// fit model}\\
      Calculate: $\E_q[\lambda_{jt}]$, $\E_q[\lambda_{jt} \mu_{jt}]$, and $\E_q[\lambda_{jt} \mu^2_{jt}]$; \texttt{// update residuals}\\
      $\tilde{r}_t := \tilde{r}_t - \E_q[\lambda_{jt}]^{-1}\E_q[\lambda_{jt} \mu_{jt}],\; \sforall t$; \\
      $\overline{\lambda}_t := \E_q[\lambda_{jt}]\overline{\lambda}_t, \; \sforall t$; \\
      $\delta_t := \delta_t + \E_q[\lambda_{jt}]^{-1}\E_q[\lambda_{jt} \mu^2_{jt}] - (\E_q[\lambda_{jt}]^{-1}\E_q[\lambda_{jt} \mu_{jt}])^2,\; \sforall t;$ \\
      $j := j + 1$; \\
    }
    \While{$\ell \leq L$} {
      $\tilde{r}_t := \tilde{r}_t + \E_q[\mu_{\ell t}],\; \sforall t$; \texttt{// calculate partial residuals} \\
      $\delta_t := \delta_t -  \Var_q(\mu_{\ell t}),\; \sforall t;$ \\
      $\{\overline{b}_{\ell t}, \overline{\tau}_{\ell t}, \overline{\pi}_{\ell t}\}_{t=1}^T := \texttt{SMCP}(\tilde{\mathbf{r}} \:;\: \overline{\pmb{\lambda}}, \tau_{\ell}, \pmb{\pi}_{\ell}, B_l,B_r);$ \texttt{// fit model} \\
      Calculate: $\E_q[\mu_{\ell t}]$ and $\Var_q(\mu_{\ell t})$; \texttt{// update residuals} \\
      $\tilde{r}_t := \tilde{r}_t - \E_q[\mu_{\ell t}],\; \sforall t$; \\
      $\delta_t := \delta_t + \Var_q(\mu_{\ell t}),\; \sforall t;$ \\
      $\ell := \ell + 1$; \\
    }
    \While{$k \leq K$} {
      $\overline{\lambda}_t := \E_q[\lambda_{k t}]^{-1}\overline{\lambda}_t, \; \sforall t$; \texttt{// calculate partial residuals}\\
      Calculate: $\tilde{v}_{kt}$ and $\tilde{\pi}_{kt}$ by (\ref{eq:mod-v_k}) and (\ref{eq:mod-pi_k}), $\sforall t$; \texttt{// calculate corrected priors} \\
      $\{\overline{u}_{kt}, \overline{v}_{kt}, \overline{\pi}_{kt}\}_{t=1}^T := \texttt{SSCP}(\tilde{\mathbf{r}} 
      \:;\:\overline{\pmb{\lambda}}, u_k, \{\tilde{v}_{kt}\}_{t=1}^T, \tilde{\pmb{\pi}}_k, B_l,B_r)$; \texttt{// fit model} \\
      Calculate: $\E_q[\lambda_{k t}]$; \texttt{// update residuals} \\
      $\overline{\lambda}_t := \E_q[\lambda_{kt}]\overline{\lambda}_t, \; \sforall t$; \\
      $k := k + 1$; \\
    }
  }
  \Return{Posterior Parameters: $\{\{\overline{b}_{jt}, \overline{\tau}_{jt}, \overline{u}_{jt}, \overline{v}_{jt}, \overline{\pi}_{jt}\}_{j=1}^J, \{\overline{b}_{\ell t}, \overline{\tau}_{\ell t}, \overline{\pi}_{\ell t}\}_{\ell=1}^L, \{\overline{u}_{kt}, \overline{v}_{kt}, \overline{\pi}_{kt}\}_{k=1}^K\}_{t=1}^T$}.
  \caption{Variational Bayes Approximation to MICH Posterior.}
\end{algorithm}